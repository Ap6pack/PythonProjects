from burp import IBurpExtender, IContextMenuFactory, IExtensionHelpers
from burp import IContextMenuInvocation
from javax.swing import JMenuItem

class BurpExtender(IBurpExtender, IContextMenuFactory):

    def registerExtenderCallbacks(self, callbacks):
        # Set up the extension
        self._callbacks = callbacks
        self._helpers = callbacks.getHelpers()
        callbacks.setExtensionName("Add Text Extension")

        # Register the context menu factory
        callbacks.registerContextMenuFactory(self)

    def createMenuItems(self, invocation):
        menu_items = []

        if invocation.getInvocationContext() == IContextMenuInvocation.CONTEXT_MESSAGE_EDITOR_REQUEST:
            menu_item = JMenuItem("Add 8KB Text to Request", actionPerformed=lambda x, inv=invocation: self.addTextToRequest(inv))
            menu_items.append(menu_item)

        return menu_items

    def addTextToRequest(self, invocation):
        context = invocation.getInvocationContext()

        if context != IContextMenuInvocation.CONTEXT_MESSAGE_EDITOR_REQUEST:
            self._callbacks.printError("This option is only available for requests.")
            return

        selected_message = invocation.getSelectedMessages()[0]
        request_info = self._helpers.analyzeRequest(selected_message)

        # Generate 8KB of text data
        text_data = "A" * 8192

        # Get the cursor position
        selection_bounds = invocation.getSelectionBounds()
        cursor_start = selection_bounds[0]
        cursor_end = selection_bounds[1]

        # Convert the original request to a string
        original_request_str = self._helpers.bytesToString(selected_message.getRequest())

        # Insert the generated text at the cursor position
        modified_request_str = original_request_str[:cursor_start] + text_data + original_request_str[cursor_end:]

        # Convert the modified request back to bytes
        modified_request = self._helpers.stringToBytes(modified_request_str)

        # Update the request with the modified text
        selected_message.setRequest(modified_request)

        # Notify the user that 8KB of text has been added at the cursor position
        self._callbacks.printOutput("8KB of text added at the cursor position.")